<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>AR Điều hướng</title>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
  <style>
    #distance-info {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 15px 25px;
      border-radius: 20px;
      font-family: Arial, sans-serif;
      font-size: 18px;
      z-index: 1000;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    #distance-info .distance {
      font-size: 32px;
      font-weight: bold;
      color: #00ff00;
      text-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
    }
    #distance-info .label {
      font-size: 14px;
      color: #aaa;
      margin-top: 5px;
    }
  </style>
  <script>
    AFRAME.registerComponent('distance-indicator', {
      schema: {
        targetLat: {type: 'number'},
        targetLon: {type: 'number'}
      },
      
      init: function() {
        this.userPosition = {lat: 0, lon: 0};
        this.distance = 0;
        this.updateDistanceDisplay();
      },
      
      tick: function() {
        const camera = this.el.sceneEl.querySelector('[gps-camera]');
        if (camera && camera.components['gps-camera']) {
          const cameraGps = camera.components['gps-camera'];
          if (cameraGps.currentPosition) {
            this.userPosition.lat = cameraGps.currentPosition.latitude;
            this.userPosition.lon = cameraGps.currentPosition.longitude;
            
            this.distance = this.calculateDistance(
              this.userPosition.lat,
              this.userPosition.lon,
              this.data.targetLat,
              this.data.targetLon
            );
            
            this.updateDistanceDisplay();
            this.updateMarkerText();
          }
        }
      },
      
      calculateDistance: function(lat1, lon1, lat2, lon2) {
        const R = 6371000;
        const dLat = this.toRad(lat2 - lat1);
        const dLon = this.toRad(lon2 - lon1);
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(this.toRad(lat1)) * Math.cos(this.toRad(lat2)) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
      },
      
      toRad: function(deg) {
        return deg * (Math.PI / 180);
      },
      
      updateDistanceDisplay: function() {
        let distanceText = '';
        if (this.distance >= 1000) {
          distanceText = (this.distance / 1000).toFixed(2) + ' km';
        } else {
          distanceText = this.distance.toFixed(0) + ' m';
        }
        
        const infoDiv = document.getElementById('distance-info');
        if (infoDiv) {
          infoDiv.innerHTML = `
            <div class="label">Khoảng cách đến điểm đến</div>
            <div class="distance">${distanceText}</div>
          `;
        }
      },
      
      updateMarkerText: function() {
        const textEl = this.el.querySelector('a-text');
        if (textEl) {
          let distanceText = '';
          if (this.distance >= 1000) {
            distanceText = (this.distance / 1000).toFixed(2) + ' km';
          } else {
            distanceText = this.distance.toFixed(0) + ' m';
          }
          textEl.setAttribute('value', `ĐIỂM ĐẾN\n${distanceText}`);
        }
      }
    });

    AFRAME.registerComponent('pulse-animation', {
      init: function() {
        this.time = 0;
      },
      tick: function(time, timeDelta) {
        this.time += timeDelta;
        const scale = 1 + Math.sin(this.time / 500) * 0.2;
        this.el.setAttribute('scale', `${scale} ${scale} ${scale}`);
      }
    });
  </script>
</head>
<body style="margin: 0; overflow: hidden;">
  
  <div id="distance-info">
    <div class="label">Đang tính khoảng cách...</div>
    <div class="distance">-- m</div>
  </div>

  <a-scene 
    vr-mode-ui="enabled: false" 
    embedded 
    arjs="sourceType: webcam; debugUIEnabled: true;">
    
    <a-entity 
      gps-entity-place="latitude: 9.974628965933842; longitude: 106.35224791780678;"
      distance-indicator="targetLat: 9.974628965933842; targetLon: 106.35224791780678">
        
        <a-sphere 
          radius="15" 
          color="#ff3333"
          pulse-animation
          material="opacity: 0.8">
        </a-sphere>
        
        <a-ring 
          radius-inner="18" 
          radius-outer="22" 
          color="#ffff00"
          rotation="-90 0 0"
          pulse-animation
          material="opacity: 0.6">
        </a-ring>
        
        <a-text 
            value="ĐIỂM ĐẾN\nĐang tính..." 
            position="0 -25 0" 
            scale="35 35 35" 
            align="center"
            color="#ffff00"
            look-at="[gps-camera]"
            material="shader: flat">
        </a-text>

        <a-cone 
          radius-bottom="8" 
          radius-top="0" 
          height="30"
          position="0 35 0"
          color="#ff9900"
          pulse-animation
          material="opacity: 0.7">
        </a-cone>

    </a-entity>

    <a-camera gps-camera rotation-reader></a-camera>
    
  </a-scene>
</body>
</html>