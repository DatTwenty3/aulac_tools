<!DOCTYPE html> 
<html lang="vi"> 
<head> 
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>LEDAT - Excel Data Processor</title> 
    <style> 
        /* General Styling */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        } 
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: #E9DDBE; /* NEW COLOR */
            min-height: 100vh; 
            padding: 20px; 
            color: #1D2536; /* NEW COLOR */
        } 
        
        /* Main Container */
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: #FFFFFF; 
            border-radius: 20px; 
            box-shadow: 0 20px 40px rgba(29, 37, 54, 0.1); /* NEW COLOR from #1D2536 */
            padding: 40px; 
            border: 1px solid rgba(29, 37, 54, 0.1); /* NEW COLOR from #1D2536 */
            animation: fadeIn 0.8s ease-out;
        } 
        
        /* Typography */
        h1 { 
            color: #1D2536; /* NEW COLOR */
            text-align: center; 
            margin-bottom: 30px; 
            font-size: 2.2rem; 
            font-weight: 600; 
            text-shadow: 0 2px 4px rgba(29, 37, 54, 0.1); /* NEW COLOR from #1D2536 */
        } 
        
        h3 { 
            color: #1D2536; /* NEW COLOR */
            margin-bottom: 15px; 
            font-size: 1.2rem; 
            font-weight: 500; 
        } 
        
        /* Input & Textarea */
        .input-section { 
            margin-bottom: 30px; 
        } 
        
        textarea { 
            width: 100%; 
            height: 200px; 
            padding: 15px; 
            border: 2px solid rgba(29, 37, 54, 0.2); /* NEW COLOR from #1D2536 */
            border-radius: 10px; 
            font-family: 'Consolas', 'Monaco', monospace; 
            font-size: 13px; 
            background: #FFFFFF;
            color: #1D2536; /* NEW COLOR */
            transition: all 0.3s ease; 
            resize: vertical; 
        } 
        
        textarea:focus { 
            outline: none; 
            border-color: #D84F34; /* NEW COLOR */
            box-shadow: 0 0 15px rgba(216, 79, 52, 0.2); /* NEW COLOR from #D84F34 */
        } 

        /* Custom Inputs */
        label {
            display: block; 
            margin-bottom: 5px; 
            font-weight: 500; 
            color: #1D2536; /* NEW COLOR */
        }

        input[type="number"] {
            padding: 8px 12px; 
            border: 2px solid rgba(29, 37, 54, 0.2); /* NEW COLOR from #1D2536 */
            border-radius: 8px; 
            font-size: 14px; 
            width: 150px;
            background: #FFFFFF;
            color: #1D2536; /* NEW COLOR */
        }
        
        /* Buttons */
        .button-group { 
            display: flex; 
            gap: 15px; 
            flex-wrap: wrap; 
            justify-content: center; 
            margin: 30px 0; 
        } 
        
        button { 
            color: #E9DDBE; /* NEW COLOR */
            padding: 12px 25px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 15px; 
            font-weight: 500; 
            transition: all 0.3s ease; 
            box-shadow: 0 4px 12px rgba(29, 37, 54, 0.3); /* NEW COLOR from #1D2536 */
        } 
        
        button:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(29, 37, 54, 0.4); /* NEW COLOR from #1D2536 */
        } 
        
        button:active { 
            transform: translateY(0); 
        }
        
        /* Set specific button colors based on new palette */
        button[onclick="processData()"] {
            background: #D84F34; /* NEW COLOR */
        }
        
        button[onclick="copyResult()"],
        button[onclick="clearData()"],
        button.csv-button,
        button.lisp-button {
            background: #1D2536; /* NEW COLOR */
        }
        
        /* Remove old specific hover styles */
        button.csv-button:hover,
        button.lisp-button:hover {
            background: #1D2536;
            filter: brightness(1.2);
        }
        
        /* Chi ti·∫øt c·ªëng selection */
        .chi-tiet-section {
            background: rgba(216, 79, 52, 0.05); /* NEW COLOR from #D84F34 */
            border: 1px solid rgba(216, 79, 52, 0.2); /* NEW COLOR from #D84F34 */
            padding: 20px;
            border-radius: 10px;
            margin: 25px 0;
        }
        
        .chi-tiet-all-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(29, 37, 54, 0.05); /* NEW COLOR from #1D2536 */
            border-radius: 8px;
        }

        .chi-tiet-all-selector select {
            padding: 8px 12px;
            border: 2px solid rgba(29, 37, 54, 0.2); /* NEW COLOR from #1D2536 */
            border-radius: 6px;
            background: #FFFFFF;
            color: #1D2536; /* NEW COLOR */
            font-size: 14px;
            cursor: pointer;
        }
        
        .chi-tiet-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .chi-tiet-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #FFFFFF;
            border-radius: 8px;
            border: 1px solid rgba(29, 37, 54, 0.1); /* NEW COLOR from #1D2536 */
        }
        
        .chi-tiet-item label {
            margin: 0;
            font-weight: 600;
            color: #1D2536; /* NEW COLOR */
            min-width: 120px;
        }
        
        .chi-tiet-item select {
            padding: 8px 12px;
            border: 2px solid rgba(29, 37, 54, 0.2); /* NEW COLOR from #1D2536 */
            border-radius: 6px;
            background: #FFFFFF;
            color: #1D2536; /* NEW COLOR */
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .chi-tiet-item select:focus {
            outline: none;
            border-color: #D84F34; /* NEW COLOR */
            box-shadow: 0 0 8px rgba(216, 79, 52, 0.2); /* NEW COLOR from #D84F34 */
        }
        
        /* Output & Table */
        .output-section { 
            margin-top: 30px; 
        } 
        
        .table-container { 
            background: #FFFFFF; 
            border-radius: 10px; 
            padding: 15px; 
            box-shadow: 0 8px 25px rgba(29, 37, 54, 0.1); /* NEW COLOR from #1D2536 */
            overflow-x: auto; 
            overflow-y: auto; 
            max-height: 500px; 
        } 
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 13px; 
            overflow: hidden; 
            border-radius: 10px; 
            min-width: 1200px; 
        } 
        
        th, td { 
            padding: 10px 12px; 
            text-align: left; 
            border-bottom: 1px solid rgba(29, 37, 54, 0.1); /* NEW COLOR from #1D2536 */
            white-space: nowrap; 
            min-width: 100px; 
        } 
        
        th { 
            background: #1D2536; /* NEW COLOR */
            color: #E9DDBE; /* NEW COLOR */
            font-weight: 500; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            font-size: 12px; 
        } 
        
        td { 
            background: #FFFFFF; 
            transition: all 0.2s ease; 
        } 
        
        tr:hover td { 
            background: rgba(29, 37, 54, 0.05); /* NEW COLOR from #1D2536 */
        } 
        
        /* Highlight */
        .changed-row td { 
            background: rgba(216, 79, 52, 0.15); /* NEW COLOR from #D84F34 */
            border-left: 3px solid #D84F34; /* NEW COLOR */
            font-weight: 500; 
        } 

        /* Scrollbar */
        .table-container::-webkit-scrollbar { 
            height: 8px; 
            width: 8px; 
        } 
        
        .table-container::-webkit-scrollbar-track { 
            background: rgba(29, 37, 54, 0.1); /* NEW COLOR from #1D2536 */
        } 
        
        .table-container::-webkit-scrollbar-thumb { 
            background: #D84F34; /* NEW COLOR */
        } 
        
        .table-container::-webkit-scrollbar-thumb:hover { 
            background: #1D2536; /* NEW COLOR */
        } 
        
        /* Animation */
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        } 
        
        /* Responsive Design */
        @media (max-width: 768px) { 
            .container { 
                margin: 10px; 
                padding: 20px; 
            } 
            
            h1 { 
                font-size: 2rem; 
            } 
            
            .button-group { 
                flex-direction: column; 
                align-items: center; 
            } 
            
            button { 
                width: 100%; 
                max-width: 300px; 
            }
            
            .chi-tiet-grid {
                grid-template-columns: 1fr;
            }
        } 
    </style> 
</head> 
<body> 
    <div class="container"> 
        <h1>üìä LEDAT - X·ª¨ L√ù D·ªÆ LI·ªÜU V·∫º TR·∫ÆC D·ªåC C·ªêNG</h1> 
        
        <div class="input-section"> 
            <h3>‚öôÔ∏è Th√¥ng s·ªë t√≠nh to√°n:</h3> 
            <div style="display: flex; gap: 20px; margin-bottom: 15px; flex-wrap: wrap;"> 
                <div> 
                    <label for="mocBanDau">M·ªëc l√Ω tr√¨nh ban ƒë·∫ßu (m):</label> 
                    <input type="number" id="mocBanDau" placeholder="V√≠ d·ª•: 0 ho·∫∑c 1234" value="0"> 
                </div> 
                <div> 
                    <label for="beRongLong">B·ªÅ r·ªông b√™n trong l√≤ng c·ªëng (m):</label> 
                    <input type="number" id="beRongLong" placeholder="V√≠ d·ª•: 1.0" value="1.0" step="0.1"> 
                </div> 
            </div> 
        </div>

        <div class="input-section"> 
            <h3>üìù D·ªØ li·ªáu ƒë·∫ßu v√†o:</h3> 
            <textarea id="inputData" placeholder="D√°n d·ªØ li·ªáu Excel c·ªßa b·∫°n v√†o ƒë√¢y..." oninput="updateChiTietOptions()"></textarea> 
        </div> 

        <div class="chi-tiet-section" id="chiTietSection" style="display: none;">
            <h3 id="chiTietTitle">üéØ Chi ti·∫øt c·ªëng cho t·ª´ng ten_gt:</h3>
            <p style="margin-bottom: 15px; color: #1D2536;">Ch·ªçn lo·∫°i chi ti·∫øt c·ªëng (VH, H10, H30) cho m·ªói gi·∫øng thu. Gi√° tr·ªã n√†y s·∫Ω ƒë∆∞·ª£c k·∫øt h·ª£p v·ªõi k√≠ch th∆∞·ªõc c·ªëng ƒë·ªÉ t·∫°o chi ti·∫øt c·ªëng.</p>
            
            <div class="chi-tiet-all-selector">
                <label for="selectAllChiTiet"><strong>Ch·ªçn nhanh cho t·∫•t c·∫£:</strong></label>
                <select id="selectAllChiTiet" onchange="applyToAllChiTiet(this.value)">
                    <option value="">-- Ch·ªçn --</option>
                    <option value="VH">VH</option>
                    <option value="H10">H10</option>
                    <option value="H30">H30</option>
                </select>
            </div>

            <div class="chi-tiet-grid" id="chiTietGrid">
            </div>
        </div>

        <div class="button-group"> 
            <button onclick="processData()">üöÄ X·ª≠ l√Ω d·ªØ li·ªáu</button> 
            <button onclick="copyResult()">üìã Sao ch√©p k·∫øt qu·∫£</button>
            <button onclick="clearData()">üóëÔ∏è X√≥a d·ªØ li·ªáu</button> 
            <button class="csv-button" onclick="downloadCSV()">üíæ T·∫£i CSV</button>
            <button class="lisp-button" onclick="downloadLisp()">üìÑ T·∫£i file LISP m·ªõi nh·∫•t</button> 
        </div> 

        <div class="output-section"> 
            <h3>üìà K·∫øt qu·∫£:</h3> 
            <div class="table-container"> 
                <div id="result"></div> 
            </div> 
            <textarea id="outputData" style="display:none;"></textarea> 
        </div> 
    </div> 

    <script> 
        let processedData = []; 
        let uniqueTenGts = []; 
        let chiTietCongMap = {}; 
        let pipeTypeMap = {};
        
        function updateChiTietOptions() {
            const input = document.getElementById('inputData').value.trim(); 
            const chiTietSection = document.getElementById('chiTietSection');
            const chiTietGrid = document.getElementById('chiTietGrid');
            const chiTietTitle = document.getElementById('chiTietTitle');
            
            document.getElementById('selectAllChiTiet').value = '';

            if (!input) {
                chiTietSection.style.display = 'none';
                return;
            }

            const lines = input.split('\n'); 
            const tenGtSet = new Set();
            const rawLoaiCongMap = {}; 

            let dominantPipeType = null;
            for (const line of lines) {
                if (line.trim() === '') continue;
                const cells = line.split(/\t|\s{2,}/).map(cell => cell.trim());
                const loaiCong = cells[1];
                if (loaiCong) {
                    if (loaiCong.trim().toUpperCase().startsWith('HV')) {
                        dominantPipeType = 'hop';
                        break;
                    } else if (loaiCong.trim().startsWith('√û')) {
                        dominantPipeType = 'tron';
                        break;
                    }
                }
            }
            
            if (dominantPipeType === 'hop') {
                chiTietTitle.innerHTML = 'üéØ Chi ti·∫øt c√°c lo·∫°i c·ªëng h·ªôp:';
            } else if (dominantPipeType === 'tron') {
                chiTietTitle.innerHTML = 'üéØ Chi ti·∫øt c√°c lo·∫°i c·ªëng tr√≤n:';
            } else {
                chiTietTitle.innerHTML = 'üéØ Chi ti·∫øt c·ªëng cho t·ª´ng ten_gt:';
            }

            lines.forEach(line => {
                if (line.trim() === '') return;
                const cells = line.split(/\t|\s{2,}/).map(cell => cell.trim());
                
                const tenGt = cells[0];
                const loaiCong = cells[1];

                if (tenGt && tenGt !== '') {
                    tenGtSet.add(tenGt);
                    if (loaiCong && loaiCong !== '' && !rawLoaiCongMap[tenGt]) {
                        rawLoaiCongMap[tenGt] = loaiCong;
                    }
                }
            });

            uniqueTenGts = Array.from(tenGtSet);
            
            if (uniqueTenGts.length > 0) {
                chiTietSection.style.display = 'block';
                
                let gridHTML = '';
                uniqueTenGts.forEach(tenGt => {
                    const currentValue = chiTietCongMap[tenGt] || '';
                    const loaiCongDisplay = rawLoaiCongMap[tenGt] || ''; 
                    const display = loaiCongDisplay ? ` (${loaiCongDisplay})` : '';
                    
                    gridHTML += `
                        <div class="chi-tiet-item">
                            <label for="select-${tenGt}">${tenGt}${display}:</label>
                            <select id="select-${tenGt}" onchange="updateChiTietCong('${tenGt}', this.value)">
                                <option value="">-- Ch·ªçn --</option>
                                <option value="VH" ${currentValue === 'VH' ? 'selected' : ''}>VH</option>
                                <option value="H10" ${currentValue === 'H10' ? 'selected' : ''}>H10</option>
                                <option value="H30" ${currentValue === 'H30' ? 'selected' : ''}>H30</option>
                            </select>
                        </div>
                    `;
                });
                chiTietGrid.innerHTML = gridHTML;
            } else {
                chiTietSection.style.display = 'none';
            }
        }

        function updateChiTietCong(tenGt, value) {
            if (value === '') {
                delete chiTietCongMap[tenGt];
            } else {
                chiTietCongMap[tenGt] = value;
            }
            document.getElementById('selectAllChiTiet').value = '';
        }

        function applyToAllChiTiet(value) {
            uniqueTenGts.forEach(tenGt => {
                if (value === '') {
                    delete chiTietCongMap[tenGt];
                } else {
                    chiTietCongMap[tenGt] = value;
                }
            });

            uniqueTenGts.forEach(tenGt => {
                const selectElement = document.getElementById(`select-${tenGt}`);
                if (selectElement) {
                    selectElement.value = value;
                }
            });
        }

        function applyLoaiCongShift(data) {
            if (data.length <= 1) return data;

            const groupedData = new Map();
            let tenGtOrder = [];

            data.forEach(row => {
                if (row.isHeader) return;
                const tenGt = row.cells[0];
                if (!tenGt) return;

                if (!groupedData.has(tenGt)) {
                    groupedData.set(tenGt, []);
                    tenGtOrder.push(tenGt);
                }
                groupedData.get(tenGt).push(row);
            });

            for (let i = 1; i < tenGtOrder.length; i++) {
                const prevTenGt = tenGtOrder[i - 1];
                const currentTenGt = tenGtOrder[i];

                const prevGroup = groupedData.get(prevTenGt);
                const currentGroup = groupedData.get(currentTenGt);

                if (!prevGroup || prevGroup.length === 0 || !currentGroup) continue;

                const inheritedLoaiCong = prevGroup[prevGroup.length - 1].cells[1];
                const originalLoaiCongs = currentGroup.map(row => row.cells[1]);
                
                for (let j = 0; j < currentGroup.length; j++) {
                    if (j === 0) {
                        currentGroup[j].cells[1] = inheritedLoaiCong;
                    } else {
                        currentGroup[j].cells[1] = originalLoaiCongs[j - 1];
                    }
                    currentGroup[j].isChanged = true;
                }
            }

            const finalData = [data[0]];
            tenGtOrder.forEach(tenGt => {
                finalData.push(...groupedData.get(tenGt));
            });

            return finalData;
        }


        function processData() { 
            const input = document.getElementById('inputData').value.trim(); 
            if (!input) { 
                alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p d·ªØ li·ªáu'); 
                return; 
            } 

            const mocBanDau = parseFloat(document.getElementById('mocBanDau').value) || 0; 
            const beRongLong = parseFloat(document.getElementById('beRongLong').value) || 2.0; 

            const lines = input.split('\n'); 
            processedData = []; 
            let lastCol1 = '', lastCol2 = '', lastCol3 = ''; 

            pipeTypeMap = {};
            lines.forEach(line => {
                if (line.trim() === '') return;
                const cells = line.split(/\t|\s{2,}/).map(cell => cell.trim());
                const tenGt = cells[0];
                const loaiCong = cells[1];
                if (tenGt && loaiCong && !pipeTypeMap[tenGt]) {
                    if (loaiCong.trim().toUpperCase().startsWith('HV')) {
                        pipeTypeMap[tenGt] = 'hop';
                    } else if (loaiCong.trim().startsWith('√û')) {
                        pipeTypeMap[tenGt] = 'tron';
                    }
                }
            });

            const headers = ['ten_gt', 'loai_cong', 'chieu_dai_cong_m', 'mat_dat_tu_nhien', 'dan_gieng_thu', 'lung_cong', 'day_dong_chay', 'day_ho_lang', 'day_mong_gieng_thu', 'day_mong_cong', 'ly_trinh', 'chi_tiet_cong']; 
            processedData.push({ 
                cells: headers, 
                isChanged: false, 
                originalIndex: -1, 
                isHeader: true 
            }); 

            lines.forEach((line, index) => { 
                if (line.trim() === '') return; 

                const cells = line.split(/\t|\s{2,}/).map(cell => cell.trim()); 
                
                while (cells.length < headers.length) { 
                    cells.push(''); 
                } 

                let isChanged = false; 

                if (cells[3] && cells[3] !== '' && (!cells[0] || cells[0] === '')) { 
                    cells[0] = lastCol1; 
                    cells[1] = lastCol2; 
                    cells[2] = lastCol3; 
                    isChanged = true; 
                } 

                const loaiCongCell = cells[1];
                if (loaiCongCell) { 
                    const hvPattern = /^HV\s*[\d,.]+\s*x\s*([\d,.]+)$/i;
                    let match = loaiCongCell.match(hvPattern);
                    if (match) {
                        const heightStr = match[1].replace(',', '.');
                        const height = parseFloat(heightStr);
                        if (!isNaN(height)) {
                            cells[1] = (height * 1000).toString();
                            isChanged = true;
                        }
                    } else {
                        const phiPattern = /^√û(\d+)$/;
                        match = loaiCongCell.match(phiPattern);
                        if (match) {
                            const number = match[1];
                            cells[1] = number + '0';
                            isChanged = true;
                        }
                    }
                }
                
                if (cells[0] && cells[0] !== '') lastCol1 = cells[0]; 
                if (cells[1] && cells[1] !== '') lastCol2 = cells[1]; 
                if (cells[2] && cells[2] !== '') lastCol3 = cells[2]; 

                processedData.push({ 
                    cells: cells, 
                    isChanged: isChanged, 
                    originalIndex: index, 
                    isHeader: false 
                }); 
            }); 

            for (let i = processedData.length - 1; i >= 1; i--) { 
                const currentRow = processedData[i]; 
                if (currentRow.isHeader) continue; 

                if (currentRow.cells[0] && currentRow.cells[0] !== '' &&  
                    (!currentRow.cells[1] || currentRow.cells[1] === '') &&  
                    (!currentRow.cells[2] || currentRow.cells[2] === '')) { 
                    
                    for (let j = i - 1; j >= 1; j--) { 
                        const prevRow = processedData[j]; 
                        if (prevRow.isHeader) continue; 
                        
                        if (prevRow.cells[1] && prevRow.cells[1] !== '' &&  
                            prevRow.cells[2] && prevRow.cells[2] !== '') { 
                            currentRow.cells[1] = prevRow.cells[1]; 
                            currentRow.cells[2] = prevRow.cells[2]; 
                            currentRow.isChanged = true; 
                            break; 
                        } 
                    } 
                } 
            } 

            processedData = applyLoaiCongShift(processedData);

            calculateLyTrinhAndChiTiet(mocBanDau, beRongLong); 

            displayResult(); 
        } 

        function calculateLyTrinhAndChiTiet(mocBanDau, beRongLong) { 
            let currentLyTrinh = mocBanDau; 
            let previousTenGt = null; 
            let previousChieuDaiCong = 0; 

            for (let i = 1; i < processedData.length; i++) { 
                const currentRow = processedData[i]; 
                if (currentRow.isHeader) continue; 

                const currentTenGt = currentRow.cells[0] || ''; 
                const chieuDaiCong = parseFloat(currentRow.cells[2]) || 0; 
                const loaiCongValue = currentRow.cells[1]; 
                const pipeType = pipeTypeMap[currentTenGt];

                const nextRow = (i + 1 < processedData.length) ? processedData[i + 1] : null; 
                const nextTenGt = nextRow ? (nextRow.cells[0] || '') : null; 

                if (currentTenGt && currentTenGt !== '') { 
                    if (currentTenGt !== previousTenGt) { 
                        if (previousTenGt !== null) { 
                            currentLyTrinh += previousChieuDaiCong + beRongLong; 
                        } 

                        if (currentTenGt === nextTenGt) { 
                            currentRow.cells[10] = ''; 
                            currentRow.cells[11] = ''; 
                        } else { 
                            const km = Math.floor(currentLyTrinh / 1000); 
                            const m = Math.round(currentLyTrinh % 1000); 
                            currentRow.cells[10] = `Km${km}+${m.toString().padStart(3, '0')}`; 
                            
                            currentRow.cells[11] = generateChiTietCong(currentTenGt, pipeType, loaiCongValue);
                        } 
                    }  
                    else { 
                        const km = Math.floor(currentLyTrinh / 1000); 
                        const m = Math.round(currentLyTrinh % 1000); 
                        currentRow.cells[10] = `Km${km}+${m.toString().padStart(3, '0')}`; 
                        
                        currentRow.cells[11] = generateChiTietCong(currentTenGt, pipeType, loaiCongValue);
                    } 

                    previousTenGt = currentTenGt; 
                    previousChieuDaiCong = chieuDaiCong; 

                } else { 
                    currentRow.cells[10] = ''; 
                    currentRow.cells[11] = ''; 
                } 
            } 
        }

        function generateChiTietCong(tenGt, pipeType, loaiCongValue) {
            const chiTiet = chiTietCongMap[tenGt]; 
            
            if (!chiTiet || !loaiCongValue || loaiCongValue.trim() === '' || !pipeType) {
                return '';
            }
            
            if (pipeType === 'hop') {
                return `CH${loaiCongValue}-${chiTiet}`;
            } else { // 'tron'
                return `D${loaiCongValue}-${chiTiet}`;
            }
        }

        function displayResult() { 
            const resultDiv = document.getElementById('result'); 
            const outputTextarea = document.getElementById('outputData'); 

            let tableHTML = '<table><thead><tr>'; 
            
            const headers = ['ten_gt', 'loai_cong', 'chieu_dai_cong_m', 'mat_dat_tu_nhien', 'dan_gieng_thu', 'lung_cong', 'day_dong_chay', 'day_ho_lang', 'day_mong_gieng_thu', 'day_mong_cong', 'ly_trinh', 'chi_tiet_cong']; 
            headers.forEach(header => { 
                tableHTML += `<th>${header}</th>`; 
            }); 
            tableHTML += '</tr></thead><tbody>'; 

            let outputText = ''; 

            processedData.forEach((row, index) => { 
                if (row.isHeader) { 
                    const rowData = []; 
                    row.cells.forEach(cell => { 
                        rowData.push(cell); 
                    }); 
                    outputText += rowData.join('\t') + '\n'; 
                    return; 
                } 

                const rowClass = row.isChanged ? 'changed-row' : ''; 
                tableHTML += `<tr class="${rowClass}">`; 
                
                const rowData = []; 
                row.cells.forEach((cell, cellIndex) => { 
                    tableHTML += `<td>${cell}</td>`; 
                    rowData.push(cell); 
                }); 
                
                tableHTML += '</tr>'; 
                outputText += rowData.join('\t') + '\n'; 
            }); 

            tableHTML += '</tbody></table>'; 
            resultDiv.innerHTML = tableHTML; 
            outputTextarea.value = outputText.trim(); 
        }

        function downloadCSV() {
            const outputTextarea = document.getElementById('outputData');
            if (outputTextarea.value === '') {
                alert('‚ö†Ô∏è Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ t·∫£i. Vui l√≤ng x·ª≠ l√Ω d·ªØ li·ªáu tr∆∞·ªõc.');
                return;
            }

            const now = new Date();
            const day = now.getDate().toString().padStart(2, '0');
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const year = now.getFullYear().toString();
            const filename = `data-${day}${month}${year}.csv`;

            const csvContent = outputTextarea.value
                .split('\n')
                .map(line => line.split('\t').join(','))
                .join('\n');

            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                alert(`‚úÖ ƒê√£ t·∫£i file ${filename} th√†nh c√¥ng!`);
            }
        }

        function copyResult() { 
            const outputTextarea = document.getElementById('outputData'); 
            if (outputTextarea.value === '') { 
                alert('‚ö†Ô∏è Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ sao ch√©p. Vui l√≤ng x·ª≠ l√Ω d·ªØ li·ªáu tr∆∞·ªõc.'); 
                return; 
            } 

            outputTextarea.style.display = 'block'; 
            outputTextarea.select(); 
            document.execCommand('copy'); 
            outputTextarea.style.display = 'none'; 
            
            alert('‚úÖ ƒê√£ sao ch√©p d·ªØ li·ªáu v√†o clipboard!'); 
        } 

        function clearData() { 
            document.getElementById('inputData').value = ''; 
            document.getElementById('result').innerHTML = ''; 
            document.getElementById('outputData').value = ''; 
            document.getElementById('chiTietSection').style.display = 'none';
            processedData = []; 
            uniqueTenGts = [];
            chiTietCongMap = {};
            pipeTypeMap = {};
        } 
        
        function downloadLisp() {
            const lispFileUrl = 'https://drive.google.com/drive/folders/146q8ahmOwP8Gzwq647zoGoKNbJ3c7y4d?usp=drive_link';
            window.open(lispFileUrl, '_blank');
            alert('‚úÖ ƒê√£ ƒëi·ªÅu h∆∞·ªõng ƒë·∫øn file LISP m·ªõi nh·∫•t!');
        }
    </script> 
</body> 
</html>
